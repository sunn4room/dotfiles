#!/usr/bin/env sh

cd "${HOME}/.config/fzflch" || exit 1
module_sel="$(fd -t x | while IFS= read -r module; do
	if printf '%s' "${module}" | grep -Eq '.*:$'; then
		"${HOME}/.config/fzflch/${module}" | sed "s/^/${module} /"
	else
		printf '%s\n' "${module}"
	fi
done | fzf --prompt "select mod > " --bind "space:accept")"

test -n "${module_sel}" || exit 0
module="${module_sel%% *}"
if test "${module_sel}" != "${module}"; then
	set -- "${module_sel#* }"
fi
while true; do
	prompt="${module}"
	if test "$#" != "0"; then
		prompt="${prompt} $*"
	fi
	if printf '%s' "${prompt}" | grep -Eq '\*$'; then
		"${HOME}/.config/fzflch/${module}" "$@"
		break
	fi
	if printf '%s' "${prompt}" | grep -Eq '\?$'; then
		userinput="$(printf "" | fzf --prompt "${prompt} > " --print-query --no-info)"
		if test -z "${userinput}"; then
			break
		else
			set -- "$@" "${userinput}"
			prompt="${prompt} ${userinput}"
		fi
	fi
	selection="$("${HOME}/.config/fzflch/${module}" "$@" | fzf --prompt "${prompt} > " --select-1 --exit-0)"
	if test -n "${selection}"; then
		set -- "$@" "${selection}"
	else
		break
	fi
done
